<% flash.each do |type, message| %>
  <p class="flash <%= type %>"><%= message %></p>
<% end %>

<h1>Checkout</h1>

<% if @cart_items.empty? %>
  <p>Your cart is empty. Please add items before proceeding to checkout.</p>
  <%= link_to "Continue Shopping", products_path %>
<% else %>
  <h2>Order Summary</h2>
  <table>
    <thead>
      <tr>
        <th>Product</th>
        <th>Quantity</th>
        <th>Price</th>
        <th>Total</th>
      </tr>
    </thead>
    <tbody>
      <% @cart_items.each do |item| %>
        <tr>
          <td><%= item[:product].respond_to?(:title) ? item[:product].title : item[:product].name %></td>
          <td><%= item[:quantity] %></td>
          <td><%= number_to_currency(item[:product].price) %></td>
          <td><%= number_to_currency(item[:product].price * item[:quantity]) %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
  <p><strong>Subtotal: <%= number_to_currency(@cart_items.sum { |item| item[:product].price * item[:quantity] }) %></strong></p>

  <% if current_customer.address.present? %>
    <h2>Shipping Address</h2>
    <p>
      <%= current_customer.address.street %>,
      <%= current_customer.address.city %>,
      <%= current_customer.address.province %>,
      <%= current_customer.address.postal_code %>
    </p>
    <%= button_to "Proceed to Payment", checkout_create_path, method: :post %>
    <%= link_to "Update Address", edit_customer_registration_path %>
  <% else %>
    <h2>Enter Shipping Address</h2>
    <%= form_with(model: @address, url: checkout_create_path, method: :post) do |form| %>
      <div>
        <%= form.label :street, "Street Address" %>
        <%= form.text_field :street, required: true %>
      </div>
      <div>
        <%= form.label :city %>
        <%= form.text_field :city, required: true %>
      </div>
      <div>
        <%= form.label :province %>
        <%= form.select :province, options_for_select(Carmen::Country.named('Canada').subregions.map(&:code)), prompt: "Select Province", required: true %>
      </div>
      <div>
        <%= form.label :postal_code %>
        <%= form.text_field :postal_code, required: true %>
      </div>
      <div>
        <%= form.submit "Proceed to Payment" %>
      </div>
    <% end %>
  <% end %>
<% end %>